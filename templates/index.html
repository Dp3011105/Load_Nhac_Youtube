<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>YouTube Music Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'wave': 'wave 1.5s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in-out': 'fadeInOut 3s ease-in-out',
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '25%': { transform: 'rotate(10deg)' },
                            '50%': { transform: 'rotate(0deg)' },
                            '75%': { transform: 'rotate(-10deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        fadeInOut: {
                            '0%': { opacity: '0' },
                            '10%': { opacity: '1' },
                            '90%': { opacity: '1' },
                            '100%': { opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .glass-card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card::before {
            content: '';
            position: absolute;
            inset: 0;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: -1;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #334155;
            overflow: hidden;
        }
        
        .progress-bar::-webkit-progress-bar {
            background: #334155;
            border-radius: 3px;
        }
        
        .progress-bar::-webkit-progress-value {
            background: #0ea5e9;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-bar::-moz-progress-bar {
            background: #0ea5e9;
            border-radius: 3px;
        }
        
        .volume-slider, .seek-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #334155;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb,
        .seek-slider::-webkit-slider-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0ea5e9;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .volume-slider::-moz-range-thumb,
        .seek-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #0ea5e9;
            cursor: pointer;
        }
        
        .playlist-item {
            transition: all 0.3s ease;
        }
        
        .playlist-item:hover {
            background: rgba(30, 41, 59, 0.5);
            transform: translateX(5px);
        }
        
        .now-playing {
            background: rgba(14, 165, 233, 0.2);
            border-left: 3px solid #0ea5e9;
        }
        
        .loading::after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }
        
        .album-art {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .album-art:hover {
            transform: scale(1.02);
        }
        
        .player-controls button {
            transition: all 0.2s ease;
        }
        
        .player-controls button:hover {
            transform: scale(1.1);
        }
        
        .player-controls button:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0284c7, #0ea5e9);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
        }
        
        .btn-secondary {
            background: rgba(30, 41, 59, 0.7);
        }
        
        .btn-secondary:hover {
            background: rgba(51, 65, 85, 0.7);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary:active {
            transform: translateY(1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .btn-danger:active {
            transform: translateY(1px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #10b981);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success:active {
            transform: translateY(1px);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, #f59e0b);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        
        .btn-warning:active {
            transform: translateY(1px);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .equalizer {
            display: flex;
            align-items: flex-end;
            height: 20px;
            gap: 3px;
        }
        
        .equalizer-bar {
            width: 3px;
            background: #0ea5e9;
            border-radius: 3px;
            animation: equalize 1.5s infinite ease-in-out;
        }
        
        .equalizer-bar:nth-child(1) { animation-delay: 0.1s; height: 60%; }
        .equalizer-bar:nth-child(2) { animation-delay: 0.3s; height: 30%; }
        .equalizer-bar:nth-child(3) { animation-delay: 0.5s; height: 75%; }
        .equalizer-bar:nth-child(4) { animation-delay: 0.2s; height: 45%; }
        .equalizer-bar:nth-child(5) { animation-delay: 0.4s; height: 60%; }
        
        @keyframes equalize {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .glass-card {
                padding: 1rem;
            }
            
            .player-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .album-art-container {
                margin-bottom: 1rem;
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .player-controls {
                flex-direction: row;
                justify-content: center;
                gap: 1.5rem;
                width: 100%;
            }
            
            .volume-controls {
                flex-direction: row;
                justify-content: center;
                gap: 0.5rem;
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
            }
            
            .volume-controls i {
                font-size: 1rem;
            }
            
            .volume-slider {
                width: 100px;
            }
            
            .playlist-management {
                width: 100%;
            }
            
            .playlist-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .playlist-buttons button,
            .playlist-buttons label {
                width: 100%;
            }
            
            .playlist-section {
                margin-top: 1.5rem;
            }
            
            .playlist-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .playlist-item .flex-1 {
                width: 100%;
            }
            
            .playlist-item-buttons {
                width: 100%;
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .album-art {
                width: 100%;
                max-width: 200px;
            }
            
            .player-controls button {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .textarea-container {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .textarea-buttons {
                flex-direction: row;
                gap: 0.5rem;
            }
            
            .textarea-buttons button {
                flex: 1;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="glass-card rounded-2xl w-full max-w-4xl p-6 shadow-xl slide-up relative">
        <div class="player-container flex flex-col md:flex-row gap-6">
            <!-- Left Column - Player Section -->
            <div class="flex-1">
                <h1 class="text-3xl font-bold mb-6 text-center md:text-left bg-gradient-to-r from-primary-400 to-primary-600 bg-clip-text text-transparent">
                    <i class="fas fa-music mr-2"></i> YouTube Music Player
                </h1>
                
                <!-- Album Art and Player -->
                <div class="album-art-container flex flex-col items-center mb-6">
                    <img id="albumArt" src="https://via.placeholder.com/300" alt="Album Art" 
                         class="album-art w-64 h-64 rounded-xl object-cover mb-4 hidden fade-in">
                    
                    <div class="w-full max-w-md">
                        <div class="flex justify-between items-center mb-2">
                            <span id="currentTime" class="text-sm text-slate-400">0:00</span>
                            <span id="duration" class="text-sm text-slate-400">0:00</span>
                        </div>
                        <input type="range" id="seekSlider" class="seek-slider w-full mb-4" min="0" max="100" value="0">
                        
                        <div class="player-controls flex items-center justify-center gap-4 mb-4">
                            <button id="prevBtn" class="text-slate-300 hover:text-white text-xl" title="Previous">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button id="playBtn" class="bg-primary-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-2xl hover:bg-primary-700" title="Play/Pause">
                                <i class="fas fa-play"></i>
                            </button>
                            <button id="nextBtn" class="text-slate-300 hover:text-white text-xl" title="Next">
                                <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                        
                        <div class="volume-controls flex items-center gap-2">
                            <i class="fas fa-volume-down text-slate-400"></i>
                            <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.7">
                            <i class="fas fa-volume-up text-slate-400"></i>
                        </div>
                    </карта>
                </div>
                
                <!-- Now Playing Info -->
                <div id="nowPlaying" class="hidden mb-6">
                    <h2 class="text-xl font-semibold mb-1 truncate" id="songTitle">No song playing</h2>
                    <p class="text-slate-400 text-sm">YouTube Music</p>
                </div>
                
                <!-- Equalizer Animation -->
                <div id="equalizer" class="equalizer justify-center hidden">
                    <div class="equalizer-bar"></div>
                    <div class="equalizer-bar"></div>
                    <div class="equalizer-bar"></div>
                    <div class="equalizer-bar"></div>
                    <div class="equalizer-bar"></div>
                </div>
            </div>
            
            <!-- Right Column - Playlist Management -->
            <div class="playlist-management flex-1">
                <div class="space-y-4">
                    <div class="textarea-container flex flex-col md:flex-row gap-2">
                        <textarea id="youtube_urls" placeholder="Dán các URL YouTube (mỗi URL một dòng)" 
                                  class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-primary-500"></textarea>
                        <div class="textarea-buttons flex md:flex-col gap-2">
                            <button id="pasteUrls" class="btn-secondary py-2 rounded-lg flex items-center justify-center gap-2">
                                <i class="fas fa-paste"></i> Dán
                            </button>
                            <button id="clearUrls" class="btn-danger py-2 rounded-lg flex items-center justify-center gap-2">
                                <i class="fas fa-trash"></i> Xóa
                            </button>
                        </div>
                    </div>
                    
                    <button id="addToPlaylist" class="btn-primary w-full py-2 rounded-lg flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> Thêm vào Playlist
                    </button>
                    
                    <div class="playlist-buttons flex flex-col md:flex-row gap-2">
                        <button id="downloadAll" class="btn-success py-2 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-download"></i> Tải Playlist
                        </button>
                        <button id="pauseDownload" class="btn-warning py-2 rounded-lg flex items-center justify-center gap-2 hidden">
                            <i class="fas fa-pause"></i> Tạm dừng
                        </button>
                    </div>
                    
                    <div class="playlist-buttons flex flex-col md:flex-row gap-2">
                        <button id="clearAll" class="btn-danger py-2 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-broom"></i> Xóa Playlist
                        </button>
                        <button id="exportJson" class="btn-secondary py-2 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-file-export"></i> Xuất JSON
                        </button>
                        <label for="importJson" class="btn-secondary py-2 rounded-lg flex items-center justify-center gap-2 cursor-pointer">
                            <i class="fas fa-file-import"></i> Nhập JSON
                            <input type="file" id="importJson" accept=".json" class="hidden">
                        </label>
                    </div>
                    
                    <div class="progress-bar hidden" id="progressBar"></div>
                    <p id="progressText" class="text-center text-sm text-slate-400 hidden"></p>
                    <p id="error" class="text-red-400 text-sm text-center hidden"></p>
                </div>
            </div>
        </div>
        
        <!-- Playlist Section -->
        <div class="playlist-section mt-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-list"></i> Playlist
                <span id="playlistCount" class="text-sm bg-slate-700 text-slate-300 px-2 py-1 rounded-full">0</span>
            </h2>
            
            <div id="playlist" class="space-y-2 max-h-80 overflow-y-auto pr-2">
                <div class="text-center text-slate-500 py-8">
                    <i class="fas fa-music text-3xl mb-2"></i>
                    <p>Playlist trống. Thêm bài hát để bắt đầu.</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="player" preload="auto"></audio>

    <script>
        // DOM Elements
        const youtubeUrls = document.getElementById('youtube_urls');
        const pasteUrlsBtn = document.getElementById('pasteUrls');
        const clearUrlsBtn = document.getElementById('clearUrls');
        const addToPlaylistBtn = document.getElementById('addToPlaylist');
        const audio = document.getElementById('player');
        const error = document.getElementById('error');
        const playlistDiv = document.getElementById('playlist');
        const downloadAllBtn = document.getElementById('downloadAll');
        const pauseDownloadBtn = document.getElementById('pauseDownload');
        const clearAllBtn = document.getElementById('clearAll');
        const exportJsonBtn = document.getElementById('exportJson');
        const importJsonInput = document.getElementById('importJson');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const albumArt = document.getElementById('albumArt');
        const nowPlaying = document.getElementById('nowPlaying');
        const songTitle = document.getElementById('songTitle');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const seekSlider = document.getElementById('seekSlider');
        const volumeSlider = document.getElementById('volumeSlider');
        const currentTime = document.getElementById('currentTime');
        const duration = document.getElementById('duration');
        const equalizer = document.getElementById('equalizer');
        const playlistCount = document.getElementById('playlistCount');

        // Variables
        let playlist = [];
        let isDownloading = false;
        let downloadIndex = 0;
        let stopDownloading = false;
        let isPlaying = false;
        let currentSongIndex = -1;
        let updateSeekSlider = true;

        // Initialize
        loadPlaylistFromCookie();
        updatePlaylistCount();

        // Event Listeners
        pasteUrlsBtn.addEventListener('click', pasteUrls);
        clearUrlsBtn.addEventListener('click', clearUrls);
        addToPlaylistBtn.addEventListener('click', addToPlaylist);
        downloadAllBtn.addEventListener('click', downloadPlaylist);
        pauseDownloadBtn.addEventListener('click', pauseDownload);
        clearAllBtn.addEventListener('click', clearAll);
        exportJsonBtn.addEventListener('click', exportJson);
        importJsonInput.addEventListener('change', importJson);
        playBtn.addEventListener('click', togglePlay);
        prevBtn.addEventListener('click', playPrevious);
        nextBtn.addEventListener('click', playNext);
        seekSlider.addEventListener('input', seekAudio);
        volumeSlider.addEventListener('input', setVolume);
        audio.addEventListener('timeupdate', updateTime);
        audio.addEventListener('ended', playNext);
        audio.addEventListener('play', () => {
            isPlaying = true;
            playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            equalizer.classList.remove('hidden');
            albumArt.classList.add('animate-pulse-slow');
        });
        audio.addEventListener('pause', () => {
            isPlaying = false;
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
            equalizer.classList.add('hidden');
            albumArt.classList.remove('animate-pulse-slow');
        });

        // Functions
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            return youtubeRegex.test(url.trim());
        }

        function loadPlaylistFromCookie() {
            const cookie = document.cookie.split('; ').find(row => row.startsWith('playlist='));
            if (cookie) {
                try {
                    playlist = JSON.parse(decodeURIComponent(cookie.split('=')[1]));
                    updatePlaylistUI();
                } catch (err) {
                    console.error('Error loading playlist from cookie:', err);
                    showError('Lỗi khi tải playlist từ cookie');
                }
            }
        }

        function savePlaylistToCookie() {
            document.cookie = `playlist=${encodeURIComponent(JSON.stringify(playlist))}; path=/; max-age=31536000`;
        }

        function updatePlaylistUI() {
            playlistDiv.innerHTML = '';
            
            if (playlist.length === 0) {
                playlistDiv.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <i class="fas fa-music text-3xl mb-2"></i>
                        <p>Playlist trống. Thêm bài hát để bắt đầu.</p>
                    </div>
                `;
                return;
            }
            
            playlist.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = `playlist-item flex justify-between items-center p-3 rounded-lg cursor-pointer ${currentSongIndex === index ? 'now-playing' : 'bg-slate-800'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="relative">
                            <img src="${song.thumbnail || 'https://via.placeholder.com/50'}" class="w-10 h-10 rounded" alt="Thumbnail">
                            ${currentSongIndex === index ? '<div class="absolute inset-0 flex items-center justify-center text-primary-400"><i class="fas fa-play"></i></div>' : ''}
                        </div>
                        <div class="min-w-0">
                            <h3 class="font-medium truncate ${currentSongIndex === index ? 'text-primary-400' : 'text-slate-200'}">${song.title || 'Unknown Title'}</h3>
                            <p class="text-xs text-slate-400 truncate">${song.url.match(/v=([^&]+)/)?.[1] || 'YouTube'}</p>
                        </div>
                    </div>
                    <div class="playlist-item-buttons flex gap-2">
                        <button onclick="playSong(${index})" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm ${song.blobUrl ? '' : 'opacity-50 cursor-not-allowed'}">
                            <i class="fas ${song.blobUrl ? 'fa-play' : 'fa-download'}"></i>
                        </button>
                        <button onclick="removeSong(${index})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                playlistDiv.appendChild(div);
            });
            
            updatePlaylistCount();
        }

        function updatePlaylistCount() {
            playlistCount.textContent = playlist.length;
        }

        async function pasteUrls() {
            try {
                const text = await navigator.clipboard.readText();
                youtubeUrls.value = text;
                hideError();
            } catch (err) {
                showError('Không thể dán từ clipboard.');
            }
        }

        function clearUrls() {
            youtubeUrls.value = '';
            hideError();
        }

        async function addToPlaylist(e) {
            e.preventDefault();
            hideError();
            
            const urls = youtubeUrls.value.split('\n').filter(url => url.trim());
            if (!urls.length) {
                showError('Vui lòng nhập ít nhất một URL YouTube');
                return;
            }

            addToPlaylistBtn.disabled = true;
            addToPlaylistBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang thêm...';
            
            let addedCount = 0;
            for (const url of urls) {
                if (!isValidYouTubeUrl(url)) {
                    showError(`URL không hợp lệ: ${url}`);
                    continue;
                }
                
                if (playlist.some(song => song.url === url)) {
                    continue;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('youtube_url', url);
                    const response = await fetch('/get_title', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        playlist.push({ 
                            url, 
                            title: data.title, 
                            thumbnail: data.thumbnail, 
                            blobUrl: null 
                        });
                        addedCount++;
                    } else {
                        const data = await response.json();
                        showError(data.error || 'Lỗi khi thêm bài hát');
                    }
                } catch (err) {
                    showError(err.message || 'Đã có lỗi xảy ra khi thêm bài hát.');
                }
            }
            
            if (addedCount > 0) {
                savePlaylistToCookie();
                updatePlaylistUI();
                showToast(`Đã thêm ${addedCount} bài hát vào playlist`);
            }
            
            youtubeUrls.value = '';
            addToPlaylistBtn.disabled = false;
            addToPlaylistBtn.innerHTML = '<i class="fas fa-plus"></i> Thêm vào Playlist';
        }

        function playSong(index) {
            if (!playlist[index].blobUrl) {
                showError('Bài hát chưa được tải');
                return;
            }
            
            currentSongIndex = index;
            audio.src = playlist[index].blobUrl;
            audio.play().catch(err => {
                console.error('Play error:', err);
                showError('Không thể phát âm thanh. Vui lòng thử trình duyệt khác.');
            });
            
            albumArt.src = playlist[index].thumbnail || 'https://via.placeholder.com/300';
            albumArt.classList.remove('hidden');
            nowPlaying.classList.remove('hidden');
            songTitle.textContent = playlist[index].title || 'Unknown Title';
            
            updatePlaylistUI();
            
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: playlist[index].title,
                    artist: 'YouTube Audio',
                    album: 'Offline Playlist',
                    artwork: [
                        { src: playlist[index].thumbnail || 'https://via.placeholder.com/512', sizes: '512x512', type: 'image/jpeg' }
                    ]
                });
            }
        }

        function removeSong(index) {
            if (playlist[index].blobUrl) {
                URL.revokeObjectURL(playlist[index].blobUrl);
            }
            
            if (currentSongIndex === index) {
                audio.pause();
                audio.src = '';
                currentSongIndex = -1;
                albumArt.classList.add('hidden');
                nowPlaying.classList.add('hidden');
            } else if (currentSongIndex > index) {
                currentSongIndex--;
            }
            
            playlist.splice(index, 1);
            savePlaylistToCookie();
            updatePlaylistUI();
            showToast('Đã xóa bài hát khỏi playlist');
        }

        async function downloadPlaylist() {
            if (isDownloading) return;
            
            isDownloading = true;
            stopDownloading = false;
            downloadAllBtn.classList.add('hidden');
            pauseDownloadBtn.classList.remove('hidden');
            progressBar.classList.remove('hidden');
            progressText.classList.remove('hidden');
            
            const songsToDownload = playlist.filter(song => !song.blobUrl);
            if (songsToDownload.length === 0) {
                showToast('Tất cả bài hát đã được tải');
                resetDownloadUI();
                return;
            }
            
            for (let i = 0; i < playlist.length; i++) {
                if (stopDownloading) break;
                if (playlist[i].blobUrl) continue;
                
                downloadIndex = i;
                progressText.textContent = `Đang tải: ${playlist[i].title || 'Bài hát ' + (i + 1)} (${i + 1}/${playlist.length})`;
                progressBar.value = (i / playlist.length) * 100;
                
                try {
                    const formData = new FormData();
                    formData.append('youtube_url', playlist[i].url);
                    const response = await fetch('/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        if (blob.size === 0) {
                            throw new Error('Dữ liệu âm thanh rỗng');
                        }
                        
                        const blobUrl = URL.createObjectURL(blob);
                        playlist[i].blobUrl = blobUrl;
                        updatePlaylistUI();
                        
                        if (currentSongIndex === i && audio.paused) {
                            audio.src = blobUrl;
                            audio.play().catch(err => {
                                console.error('Play error after download:', err);
                            });
                        }
                    } else {
                        const data = await response.json();
                        showError(data.error || 'Lỗi khi tải bài hát');
                    }
                } catch (err) {
                    console.error('Download error:', err);
                    showError(err.message || 'Lỗi khi tải bài hát.');
                }
            }
            
            resetDownloadUI();
            if (!stopDownloading) {
                showToast('Đã tải xong playlist');
            }
        }

        function resetDownloadUI() {
            isDownloading = false;
            downloadAllBtn.classList.remove('hidden');
            pauseDownloadBtn.classList.add('hidden');
            progressBar.classList.add('hidden');
            progressText.classList.add('hidden');
            progressBar.value = 0;
        }

        function pauseDownload() {
            stopDownloading = true;
            isDownloading = false;
            resetDownloadUI();
            showToast('Đã tạm dừng tải playlist');
        }

        function clearAll() {
            if (playlist.length === 0) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ playlist?')) {
                playlist.forEach(song => {
                    if (song.blobUrl) URL.revokeObjectURL(song.blobUrl);
                });
                
                playlist = [];
                currentSongIndex = -1;
                savePlaylistToCookie();
                updatePlaylistUI();
                
                audio.pause();
                audio.src = '';
                albumArt.classList.add('hidden');
                nowPlaying.classList.add('hidden');
                
                showToast('Đã xóa toàn bộ playlist');
            }
        }

        function exportJson() {
            if (playlist.length === 0) {
                showError('Playlist trống, không có gì để xuất');
                return;
            }
            
            const json = JSON.stringify(playlist.map(song => ({ 
                url: song.url, 
                title: song.title, 
                thumbnail: song.thumbnail 
            })));
            
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'youtube_playlist.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('Đã xuất playlist thành file JSON');
        }

        function importJson(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedPlaylist = JSON.parse(event.target.result);
                    if (!Array.isArray(importedPlaylist) || !importedPlaylist.every(song => song.url && song.title)) {
                        throw new Error('File JSON không hợp lệ.');
                    }
                    
                    if (playlist.length > 0) {
                        if (!confirm('Bạn có muốn thay thế playlist hiện tại bằng playlist mới?')) {
                            return;
                        }
                        clearAll();
                    }
                    
                    playlist = importedPlaylist.map(song => ({ ...song, blobUrl: null }));
                    savePlaylistToCookie();
                    updatePlaylistUI();
                    showToast(`Đã nhập ${playlist.length} bài hát từ file JSON`);
                } catch (err) {
                    console.error('Import error:', err);
                    showError('Lỗi khi nhập JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function togglePlay() {
            if (!audio.src) {
                if (playlist.length > 0) {
                    playSong(0);
                } else {
                    showError('Không có bài hát nào trong playlist');
                }
                return;
            }
            
            if (audio.paused) {
                audio.play().catch(err => {
                    console.error('Play error:', err);
                    showError('Không thể phát âm thanh');
                });
            } else {
                audio.pause();
            }
        }

        function playPrevious() {
            if (playlist.length === 0) return;
            
            const newIndex = currentSongIndex <= 0 ? playlist.length - 1 : currentSongIndex - 1;
            playSong(newIndex);
        }

        function playNext() {
            if (playlist.length === 0) return;
            
            const newIndex = currentSongIndex >= playlist.length - 1 ? 0 : currentSongIndex + 1;
            playSong(newIndex);
        }

        function seekAudio() {
            if (!audio.src) return;
            
            const seekTime = (seekSlider.value / 100) * audio.duration;
            audio.currentTime = seekTime;
        }

        function setVolume() {
            audio.volume = volumeSlider.value;
        }

        function updateTime() {
            if (!audio.src) return;
            
            const minutes = Math.floor(audio.currentTime / 60);
            const seconds = Math.floor(audio.currentTime % 60);
            currentTime.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (audio.duration) {
                const durMinutes = Math.floor(audio.duration / 60);
                const durSeconds = Math.floor(audio.duration % 60);
                duration.textContent = `${durMinutes}:${durSeconds < 10 ? '0' : ''}${durSeconds}`;
            }
            
            if (updateSeekSlider) {
                seekSlider.value = (audio.currentTime / audio.duration) * 100 || 0;
            }
        }

        function showError(message) {
            error.textContent = message;
            error.classList.remove('hidden');
            setTimeout(hideError, 5000);
        }

        function hideError() {
            error.classList.add('hidden');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-fade-in-out';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Media Session API support
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', togglePlay);
            navigator.mediaSession.setActionHandler('pause', togglePlay);
            navigator.mediaSession.setActionHandler('previoustrack', playPrevious);
            navigator.mediaSession.setActionHandler('nexttrack', playNext);
        }

        // Drag and drop for album art (visual effect)
        albumArt.addEventListener('dragstart', (e) => {
            e.preventDefault();
        });

        let isDragging = false;
        let startY = 0;
        let startX = 0;

        albumArt.addEventListener('mousedown', (e) => {
            isDragging = true;
            startY = e.clientY;
            startX = e.clientX;
            albumArt.style.cursor = 'grabbing';
            albumArt.style.transition = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const yDiff = e.clientY - startY;
            const xDiff = e.clientX - startX;
            
            albumArt.style.transform = `translate(${xDiff}px, ${yDiff}px) rotate(${xDiff * 0.2}deg)`;
        });

        document.addEventListener('mouseup', () => {
            if (!isDragging) return;
            
            isDragging = false;
            albumArt.style.transform = '';
            albumArt.style.cursor = '';
            albumArt.style.transition = 'all 0.3s ease';
        });

        // Touch support for mobile
        albumArt.addEventListener('touchstart', (e) => {
            isDragging = true;
            startY = e.touches[0].clientY;
            startX = e.touches[0].clientX;
            albumArt.style.transition = 'none';
        });

        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            
            const yDiff = e.touches[0].clientY - startY;
            const xDiff = e.touches[0].clientX - startX;
            
            albumArt.style.transform = `translate(${xDiff}px, ${yDiff}px) rotate(${xDiff * 0.2}deg)`;
        });

        document.addEventListener('touchend', () => {
            if (!isDragging) return;
            
            isDragging = false;
            albumArt.style.transform = '';
            albumArt.style.transition = 'all 0.3s ease';
        });
    </script>
</body>
</html>